version: '3.9'
services:
  localstack:
    container_name: "localstack"
    image: localstack/localstack:latest
    ports:
      - 4566:4566            # LocalStack Gateway
      - 4510-4559:4510-4559  # external services port range
      - 8080:8080
    environment:
      DEBUG: 1
      SERVICES: s3, s3control
      START_WEB: 1
      PORT_WEB_UI: 8080
      LAMBDA_REMOTE_DOCKER: 0
      DATA_DIR: /tmp/localstack/data
      DEFAULT_REGION: ca-central-1
      DOCKER_HOST: unix:///var/run/docker.sock
      HOSTNAME_EXTERNAL: localstack
      HOSTNAME: localstack
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./aws/dev/init-aws.sh:/etc/localstack/init/ready.d/init-aws.sh
  authoring-editor-db:
    image: '${DBIMAGE}'
    restart: 'always'
    ports:
      - '${DBPORT}:${DBPORT}'
    environment:
      POSTGRES_PASSWORD: '${DBPASS}'
      POSTGRES_USER: '${DBUSER}'
  authoring-editor-server:
    build:
      context: ../
      dockerfile: containers/development.dockerfile
    environment:
      AWS_ENDPOINT: http://localstack:4566
    ports:
      - '${SRPORT}:${SRPORT}'
    volumes:
      - ../packages/editor/package.json:/usr/authoring/packages/editor/package.json
      - ../packages/editor/src/main:/usr/authoring/packages/editor/src/main
      - ../packages/editor/src/server:/usr/authoring/packages/editor/src/server
      - ../packages/editor/src/app:/usr/authoring/packages/editor/src/app
      - ../packages/content-block-editor-react/dist:/usr/authoring/packages/content-block-editor-react/dist